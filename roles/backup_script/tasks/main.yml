---
# Main Ansible tasks for backup_script role
- name: Ensure backup user exists
  ansible.builtin.user:
    name: "{{ backup_user }}"
    state: present
    shell: /bin/bash

- name: Ensure required directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ backup_user }}"
    group: "{{ backup_user }}"
    mode: '0700'
  loop:
    - "{{ backup_home }}/.local/bin"
    - "{{ backup_home }}/.config/archive"
    - "{{ backup_home }}/.config/systemd/user"
    - "{{ backup_home }}/backup/archive-snapshots"

- name: Copy archive script
  ansible.builtin.copy:
    src: archive.sh
    dest: "{{ backup_home }}/.local/bin/archive.sh"
    owner: "{{ backup_user }}"
    group: "{{ backup_user }}"
    mode: '0700'

- name: Copy zfs-snap.py
  ansible.builtin.copy:
    src: zfs-snap.py
    dest: "{{ backup_home }}/.local/bin/zfs-snap.py"
    owner: "{{ backup_user }}"
    group: "{{ backup_user }}"
    mode: '0700'

- name: Copy archive config
  ansible.builtin.copy:
    src: archive.conf
    dest: "{{ backup_home }}/.config/archive/config"
    owner: "{{ backup_user }}"
    group: "{{ backup_user }}"
    mode: '0600'

- name: Deploy msmtp config
  ansible.builtin.template:
    src: msmtprc.j2
    dest: "{{ backup_home }}/.msmtprc"
    owner: "{{ backup_user }}"
    group: "{{ backup_user }}"
    mode: '0600'

- name: Deploy systemd service
  ansible.builtin.template:
    src: archive.service.j2
    dest: "{{ backup_home }}/.config/systemd/user/archive.service"
    owner: "{{ backup_user }}"
    group: "{{ backup_user }}"
    mode: '0644'

- name: Deploy systemd timer
  ansible.builtin.template:
    src: archive.timer.j2
    dest: "{{ backup_home }}/.config/systemd/user/archive.timer"
    owner: "{{ backup_user }}"
    group: "{{ backup_user }}"
    mode: '0644'

- name: Install sudoers file for btrfs commands
  ansible.builtin.template:
    src: sudoers_btrfs.j2
    dest: "/etc/sudoers.d/archive-snapshots"
    owner: root
    group: root
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Reload systemd user daemon
  ansible.builtin.command: >
    loginctl enable-linger {{ backup_user }}
  become: true
  changed_when: false

- name: Reload systemd user units
  ansible.builtin.command: >
    systemctl --user daemon-reload
  become: true
  become_user: "{{ backup_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ lookup('ansible.builtin.pipe', 'id -u ' + backup_user) }}"

- name: Enable and start archive timer
  ansible.builtin.systemd:
    name: archive.timer
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ backup_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ lookup('ansible.builtin.pipe', 'id -u ' + backup_user) }}"
